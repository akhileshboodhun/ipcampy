#!/usr/bin/env python

# Andrea Masi 2014 eraclitux@gmail.com

import argparse
import multiprocessing

from ipcampy.sentry import load_cams, watch
from ipcamweb.dashboard import app

parser = argparse.ArgumentParser(
    description = "Start capturing snapshots from all cams defined in configuration file",
)

parser.add_argument(
        '-d',
        '--cams-data',
        required = True,
        metavar = 'PATH',
        help = 'Path to the cams configuration (json format).',
)

if __name__ == '__main__':
    args = parser.parse_args()
    args_dict = vars(args)
    # FIXME hackish, one day replace cams duplication
    # with communication between processes
    cams = load_cams(args_dict["cams_data"])
    app.cams = cams
    cam_sentry = multiprocessing.Process(target = watch, args = (cams,))
    web_dashboard = multiprocessing.Process(target = app.run)
    cam_sentry.start()
    web_dashboard.start()
    cam_sentry.join()
    web_dashboard.join()
